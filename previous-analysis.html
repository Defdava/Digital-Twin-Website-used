<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>BRIN Previous Analysis</title>
  <link rel="stylesheet" href="../CSS/mainstyle.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
const firebaseConfig = {
  apiKey: "AIzaSyAef3SJwvVVTunr6CWki79aenfpXlgYc0s",
  authDomain: "digitaltwinparkingbrin.firebaseapp.com",
  databaseURL: "https://digitaltwinparkingbrin-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "digitaltwinparkingbrin",
  storageBucket: "digitaltwinparkingbrin.firebasestorage.app",
  messagingSenderId: "608462498913",
  appId: "1:608462498913:web:73695d8c91f923e2db8e20",
  measurementId: "G-F1TRY65RTG"
};

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <style>
    .status.in {
      color: red;
      font-weight: bold;
    }

    .status.out {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <video id="bg-video" autoplay muted loop>
    <source src="../assets/wave.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>

  <header>
    <div class="logo" id="toggleToolbar">
      <img src="../assets/Logo_BRIN.png" alt="BRIN Logo">
      <span>BRIN</span>
      <span>Badan Riset Nasional</span>
    </div>
    <div class="header-right">
      <span>Parking Management System</span>
    </div>
  </header>

  <aside class="toolbar" id="toolbar">
    <div class="feature-box">
      <h3>Parking Management System</h3>
    </div>
    <div class="feature-box">
      <button class="live-overview" onclick="window.location.href='index.html'">Live Overview</button>
      <button class="prev-analysis" onclick="window.location.href='previous-analysis.html'">Previous Analysis</button>
    </div>
    <div class="feature-box user-info" id="userInfo">
      <h3>User</h3>
      <img src="../assets/user.JPG" alt="User">
      <span>Welcome Back</span>
      <span id="userName">Defdava Haryadi</span>
      <button class="logout">Log Out</button>
    </div>
    <div class="feature-box">
      <button class="export-data" onclick="window.location.href='export-data.html'">Export Data</button>
      <button class="3d-viewer-vr" onclick="window.location.href='3d-viewer-vr.html'">3D Viewer VR</button>
      <button class="helpdesk" onclick="window.location.href='helpdesk.html'">Helpdesk</button>
      <button class="profile" onclick="window.location.href='profile.html'">Profile</button>
      <button class="parking-analysis" onclick="window.location.href='parking-analysis.html'">Parking Analysis</button>
    </div>
  </aside>

  <main class="main-content">
    <div class="overview">
      <h1>Previous Analysis</h1>
      <div class="history">
        <h2>Status Slot Parkir Realtime</h2>
        <div id="slotStatusList" class="history-list">
          <!-- Slot parkir akan muncul di sini -->
        </div>
      </div>
    </div>
  </main>

  <script src="../JS/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Cek user session
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      const userInfo = document.getElementById('userInfo');
      const userName = document.getElementById('userName');
      if (!currentUser) {
        alert('Silakan login terlebih dahulu!');
        window.location.replace('../HTML/login.html');
        return;
      } else {
        userName.textContent = currentUser.username;
      }

      // Logout handler
      document.querySelector('.logout').addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        alert('Berhasil logout!');
        window.location.replace('../HTML/login.html');
      });

      // Toolbar toggle animation
      const toggleToolbar = document.getElementById('toggleToolbar');
      const toolbar = document.getElementById('toolbar');
      toggleToolbar.addEventListener('click', () => {
        toolbar.classList.toggle('active');
      });

      // Prevent undo/redo navigation
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'y' || e.key === 'Z' || e.key === 'Y')) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Undo/Redo is disabled');
        }
      });

      // Prevent back/forward navigation
      history.replaceState(null, null, window.location.href);
      window.addEventListener('popstate', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!localStorage.getItem('currentUser')) {
          window.location.replace('../HTML/login.html');
        } else {
          history.replaceState(null, null, window.location.href);
        }
      });

      // Real-time slot status handler
      const slotStatusList = document.getElementById("slotStatusList");

      function updateSlotStatus(data) {
        slotStatusList.innerHTML = ''; // Bersihkan dulu
        for (const slot in data) {
          const status = data[slot] ? 'Terisi' : 'Kosong';
          const statusClass = data[slot] ? 'status in' : 'status out';

          const slotDiv = document.createElement("div");
          slotDiv.classList.add("history-item");

          slotDiv.innerHTML = `
            <span>${slot.replace('_', ' ').toUpperCase()}</span>
            <span class="${statusClass}">${status}</span>
          `;

          slotStatusList.appendChild(slotDiv);
        }
      }

      const dbRef = firebase.database().ref("slot_parking");
      dbRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) updateSlotStatus(data);
      });
    });
  </script>
</body>
</html>
