<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>BRIN Previous Analysis</title>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; 
      padding: 0; 
      color: darkslategrey; 
      overflow-x: hidden; 
    }
    body::before { 
      content: ""; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: none; 
      opacity: 0.2; 
      z-index: -1; 
    }
    video#bg-video { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
      z-index: -2; 
      opacity: 0.4; 
    }
    header { 
      background-image: linear-gradient(to right, lightseagreen, palevioletred); 
      color: white; 
      padding: 10px 20px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      position: fixed; 
      width: 100%; 
      top: 0; 
      z-index: 1000; 
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
    }
    .logo { 
      display: flex; 
      align-items: center; 
      cursor: pointer; 
    }
    .logo img { 
      height: 40px; 
      vertical-align: middle; 
    }
    .logo span { 
      margin-left: 10px; 
      font-size: 16px; 
      font-weight: bold; 
    }
    .header-right { 
      display: flex; 
      align-items: center; 
    }
    .header-right span { 
      margin-right: 20px; 
      font-size: 14px; 
    }
    .main-content { 
      margin-left: 0; 
      padding: 80px 20px 20px; 
      min-height: 100vh; 
    }
    .toolbar { 
      position: fixed; 
      top: 60px; 
      left: -400px; 
      width: 200px; 
      height: 100%; 
      background-image: linear-gradient(to bottom, lightseagreen, palevioletred); 
      padding: 15px; 
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
      transition: left 0.3s ease-in-out; 
      z-index: 999; 
      overflow-y: auto; 
    }
    .toolbar.active { 
      left: 0; 
    }
    .toolbar .feature-box { 
      background-color: lightgrey; 
      border-radius: 8px; 
      padding: 12px; 
      margin-bottom: 16px; 
      font-size: 13px; 
    }
    .toolbar .feature-box h3 { 
      margin: 0 0 8px; 
      font-size: 14px; 
      color: black; 
    }
    .toolbar .feature-box button { 
      width: 100%; 
      padding: 6px; 
      background-color: darkgrey; 
      color: black; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-size: 11px; 
      margin-bottom: 4px; 
      transition: background-color 0.3s; 
    }
    .toolbar .feature-box button:hover { 
      background-color: darkslategrey; 
      color: white; 
    }
    .toolbar .user-info { 
      text-align: center; 
    }
    .toolbar .user-info img { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      margin-bottom: 8px; 
    }
    .toolbar .user-info span { 
      display: block; 
      margin: 4px 0; 
      font-size: 11px; 
      color: black; 
    }
    .overview { 
      background-color: lightgrey; 
      padding: 20px; 
      border-radius: 8px; 
      border: 2px solid #dc3545; 
      margin-bottom: 20px; 
    }
    .overview h1 { 
      margin: 0 0 15px; 
      color: #007bff; 
      font-size: 20px; 
      font-weight: bold; 
    }
    .history, .customers { 
      background-color: white; 
      padding: 15px; 
      border-radius: 8px; 
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
      margin-bottom: 20px; 
    }
    .history h2, .customers h2 { 
      margin: 0 0 10px; 
      color: #007bff; 
      font-size: 16px; 
      font-weight: bold; 
    }
    .history-list { 
      max-height: 200px; 
      overflow-y: auto; 
      border: 1px solid #ddd; 
      padding: 10px; 
      border-radius: 5px; 
      background: #f9f9f9; 
    }
    .history-item, .customer-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 10px; 
      font-size: 12px; 
      border-bottom: 1px solid #eee; 
      transition: background 0.2s; 
    }
    .history-item:last-child, .customer-item:last-child { 
      border-bottom: none; 
    }
    .history-item:hover, .customer-item:hover { 
      background: #f0f0f0; 
    }
    .status.in { 
      color: red; 
      font-weight: bold; 
      background: #ffe6e6; 
      padding: 5px 10px; 
      border-radius: 5px; 
    }
    .status.out { 
      color: green; 
      font-weight: bold; 
      background: #e6ffe6; 
      padding: 5px 10px; 
      border-radius: 5px; 
    }
    .customer-item { 
      flex-direction: column; 
      align-items: flex-start; 
      gap: 5px; 
      font-size: 13px; 
    }
    .customer-item strong { 
      color: #333; 
      font-size: 14px; 
      margin-bottom: 5px; 
    }
    .customer-item span { 
      display: block; 
      color: #555; 
    }
    .customer-item button.edit-btn {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 11px;
      margin-top: 5px;
      transition: background-color 0.3s;
    }
    .customer-item button.edit-btn:hover {
      background-color: #0056b3;
    }
    .edit-form {
      display: none;
      flex-direction: column;
      gap: 5px;
      width: 100%;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 5px;
    }
    .edit-form input {
      padding: 5px;
      font-size: 12px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }
    .edit-form button {
      padding: 5px 10px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 11px;
      margin-top: 5px;
    }
    .edit-form button:hover {
      background-color: #218838;
    }
    .edit-form button.cancel-btn {
      background-color: #dc3545;
    }
    .edit-form button.cancel-btn:hover {
      background-color: #c82333;
    }
    .filter-container {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-container input {
      padding: 5px;
      font-size: 12px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background-color: white;
      width: 120px;
    }
    #error-message {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 10px;
      z-index: 1001;
      display: none;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAef3SJwvVVTunr6CWki79aenfpXlgYc0s",
      authDomain: "digitaltwinparkingbrin.firebaseapp.com",
      databaseURL: "https://digitaltwinparkingbrin-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "digitaltwinparkingbrin",
      storageBucket: "digitaltwinparkingbrin.firebasestorage.app",
      messagingSenderId: "608462498913",
      appId: "1:608462498913:web:73695d8c91f923e2db8e20",
      measurementId: "G-F1TRY65RTG"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body>
  <video id="bg-video" autoplay muted loop>
    <source src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/wave.mp4?raw=true" type="video/mp4">
  </video>

  <header>
    <div class="logo" id="toggleToolbar">
      <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo">
      <span>BRIN</span><span>Badan Riset Nasional</span>
    </div>
    <div class="header-right"><span>Parking Management System</span></div>
  </header>

  <aside class="toolbar" id="toolbar">
    <div class="feature-box user-info" id="userInfo">
      <h3>User</h3>
      <img id="profilePic" src="/assets/user.JPG" alt="User">
      <span>Welcome Back</span>
      <span id="userName"></span>
      <button class="profile" onclick="window.location.href='/profile.html'">Profile</button>
      <button class="logout">Log Out</button>
    </div>
    <div class="feature-box">
      <h3>Parking Management System</h3>
      <button class="live-overview" onclick="window.location.href='/index.html'">Live Overview</button>
      <button class="prev-analysis" onclick="window.location.href='/previous-analysis.html'">Previous Analysis</button>
      <button class="export-data">Export Data</button>
      <button class="3d-viewer-vr">3D Viewer VR</button>
      <button class="helpdesk">Helpdesk</button>
      <button class="parking-analysis">Parking Analysis</button>
    </div>
  </aside>

  <main class="main-content">
    <div class="overview">
      <h1>Previous Analysis</h1>
      <div class="history">
        <h2>Status Slot Parkir Realtime</h2>
        <div id="slotStatusList" class="history-list"></div>
      </div>
      <div class="customers">
        <h2>Customers Message</h2>
        <div class="filter-container">
          <input type="text" id="slotFilter" placeholder="Filter by Slot (e.g., slot_1)" oninput="updateCustomersMessage()">
          <input type="date" id="dateFilter" oninput="updateCustomersMessage()">
          <input type="text" id="nameFilter" placeholder="Filter by Name" oninput="updateCustomersMessage()">
        </div>
        <div id="customersMessageList" class="history-list"></div>
        <div id="error-message"></div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        alert('Silakan login terlebih dahulu!');
        window.location.replace('/login.html');
        return;
      }
      document.getElementById('userName').textContent = currentUser.username;
      document.getElementById('profilePic').src = currentUser.profilePic || '/assets/user.JPG';

      document.querySelector('.logout').addEventListener('click', () => {
        localStorage.removeItem('currentUser');
        alert('Berhasil logout!');
        window.location.replace('/login.html');
      });

      document.getElementById('toggleToolbar').addEventListener('click', () => {
        document.getElementById('toolbar').classList.toggle('active');
      });

      function showError(message) {
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        setTimeout(() => { errorElement.style.display = 'none'; }, 5000);
      }

      // Realtime Slot Status
      const slotStatusList = document.getElementById("slotStatusList");
      function updateSlotStatus(data) {
        slotStatusList.innerHTML = '';
        for (const slot in data) {
          const status = data[slot] ? 'Terisi' : 'Kosong';
          const statusClass = data[slot] ? 'status in' : 'status out';
          slotStatusList.innerHTML += `
            <div class="history-item">
              <span>${slot.replace('_', ' ').toUpperCase()}</span>
              <span class="${statusClass}">${status}</span>
            </div>
          `;
        }
      }
      firebase.database().ref("slot_parking").on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          updateSlotStatus(data);
        } else {
          showError('No slot status data available');
        }
      }, (error) => {
        showError(`Failed to fetch slot status: ${error.message}`);
      });

      // Realtime Customers Message
      const customersMessageList = document.getElementById("customersMessageList");
      let messagesData = [];

      function showEditForm(slot, message) {
        const formId = `edit-form-${slot}`;
        const existingForm = document.getElementById(formId);
        if (existingForm) {
          existingForm.style.display = existingForm.style.display === 'none' ? 'flex' : 'none';
          return;
        }

        const form = document.createElement('div');
        form.className = 'edit-form';
        form.id = formId;
        form.innerHTML = `
          <input type="text" id="edit-contactNumber-${slot}" value="${message.contactNumber || ''}" placeholder="Contact Number">
          <input type="text" id="edit-idWorker-${slot}" value="${message.idWorker || ''}" placeholder="ID Worker">
          <input type="text" id="edit-lastAction-${slot}" value="${message.lastAction || ''}" placeholder="Last Action">
          <input type="text" id="edit-parkingNotes-${slot}" value="${message.parkingNotes || ''}" placeholder="Parking Notes">
          <input type="text" id="edit-plate-${slot}" value="${message.plate || ''}" placeholder="Plate">
          <input type="text" id="edit-timestamp-${slot}" value="${message.timestamp || ''}" placeholder="Timestamp (HH:MM:SS)">
          <input type="text" id="edit-user-${slot}" value="${message.user || ''}" placeholder="User">
          <input type="date" id="edit-date-${slot}" value="${message.date ? message.date.split('T')[0] : ''}" placeholder="Date">
          <button onclick="saveMessage('${slot}')">Save</button>
          <button class="cancel-btn" onclick="document.getElementById('${formId}').style.display = 'none'">Cancel</button>
        `;
        return form;
      }

      function saveMessage(slot) {
        const updatedMessage = {
          contactNumber: document.getElementById(`edit-contactNumber-${slot}`).value || null,
          idWorker: document.getElementById(`edit-idWorker-${slot}`).value || null,
          lastAction: document.getElementById(`edit-lastAction-${slot}`).value || null,
          parkingNotes: document.getElementById(`edit-parkingNotes-${slot}`).value || null,
          plate: document.getElementById(`edit-plate-${slot}`).value || null,
          timestamp: document.getElementById(`edit-timestamp-${slot}`).value || null,
          user: document.getElementById(`edit-user-${slot}`).value || null,
          date: document.getElementById(`edit-date-${slot}`).value || null
        };

        firebase.database().ref(`slot_message_user/${slot}`).set(updatedMessage)
          .then(() => {
            showError('Message updated successfully');
            document.getElementById(`edit-form-${slot}`).style.display = 'none';
          })
          .catch((error) => {
            showError(`Failed to update message: ${error.message}`);
          });
      }

      function updateCustomersMessage() {
        const slotFilter = document.getElementById('slotFilter').value.toLowerCase();
        const dateFilter = document.getElementById('dateFilter').value;
        const nameFilter = document.getElementById('nameFilter').value.toLowerCase();

        customersMessageList.innerHTML = '';

        const filteredMessages = messagesData.filter(({ slot, message }) => {
          let matchesSlot = true;
          let matchesDate = true;
          let matchesName = true;

          if (slotFilter) {
            matchesSlot = slot.toLowerCase().includes(slotFilter);
          }
          if (dateFilter) {
            const firebaseDate = message.date ? message.date.split('T')[0] : 'N/A';
            matchesDate = firebaseDate === dateFilter;
          }
          if (nameFilter) {
            matchesName = (message.user || '').toLowerCase().includes(nameFilter);
          }

          return matchesSlot && matchesDate && matchesName;
        });

        if (!filteredMessages.length) {
          customersMessageList.innerHTML = '<div>No messages match the filter criteria</div>';
          return;
        }

        filteredMessages.forEach(({ slot, message }) => {
          const { contactNumber, idWorker, lastAction, parkingNotes, plate, timestamp, user, date } = message;
          const itemDiv = document.createElement('div');
          itemDiv.className = 'customer-item';
          itemDiv.innerHTML = `
            <strong>${slot.replace('_', ' ').toUpperCase()}</strong>
            <span>Contact: ${contactNumber || 'N/A'}</span>
            <span>ID Worker: ${idWorker || 'N/A'}</span>
            <span>Last Action: ${lastAction || 'N/A'}</span>
            <span>Parking Notes: ${parkingNotes || 'N/A'}</span>
            <span>Plate: ${plate || 'N/A'}</span>
            <span>Timestamp: ${timestamp || 'N/A'}</span>
            <span>User: ${user || 'N/A'}</span>
            <span>Date: ${date || 'N/A'}</span>
            <button class="edit-btn" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'flex' : 'none'">Edit</button>
          `;
          itemDiv.appendChild(showEditForm(slot, message));
          customersMessageList.appendChild(itemDiv);
        });
      }

      firebase.database().ref("slot_message_user").on("value", (snapshot) => {
        const data = snapshot.val();
        messagesData = [];
        if (data) {
          for (const slot in data) {
            messagesData.push({ slot, message: data[slot] });
          }
          updateCustomersMessage();
        } else {
          customersMessageList.innerHTML = '<div>No messages available</div>';
          showError('No customer messages available');
        }
      }, (error) => {
        showError(`Failed to fetch customer messages: ${error.message}`);
      });

      // Prevent Undo/Redo
      document.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && (event.key === 'z' || event.key === 'y' || event.key === 'Z' || event.key === 'Y')) {
          event.preventDefault();
          event.stopPropagation();
          console.log('Undo/Redo is disabled');
        }
      });
    });
  </script>
</body>
</html>