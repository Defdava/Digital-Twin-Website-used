<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BRIN Parking Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.10/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <video id="bg-video" autoplay muted loop class="fixed top-0 left-0 w-full h-full object-cover z-[-2] opacity-40">
        <source src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/wave.mp4?raw=true" type="video/mp4">
    </video>
    <div id="root"></div>

    <script type="text/babel">
        function App() {
            const [isToolbarActive, setIsToolbarActive] = React.useState(false);
            const [currentTime, setCurrentTime] = React.useState('');
            const [messages, setMessages] = React.useState([]);
            const [sortOption, setSortOption] = React.useState('slot');
            const [error, setError] = React.useState(null);
            const [user, setUser] = React.useState(null);

            // Update clock
            React.useEffect(() => {
                const updateClock = () => {
                    const now = new Date();
                    const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
                    setCurrentTime(new Intl.DateTimeFormat('en-US', options).format(now) + ' WIB');
                };
                updateClock();
                const interval = setInterval(updateClock, 1000);
                return () => clearInterval(interval);
            }, []);

            // Load user from localStorage
            React.useEffect(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) setUser(currentUser);
            }, []);

            // Fetch messages from backend
            React.useEffect(() => {
                fetch(`http://localhost:3000/api/messages?sort=${sortOption}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            setError(data.error);
                            setMessages([]);
                        } else {
                            setMessages(data);
                            setError(null);
                        }
                    })
                    .catch(err => {
                        setError('Failed to fetch messages');
                        setMessages([]);
                    });
            }, [sortOption]);

            // Handle logout
            const handleLogout = () => {
                localStorage.removeItem('currentUser');
                alert('Berhasil logout!');
                window.location.replace('/login.html');
            };

            // Toggle toolbar
            const toggleToolbar = () => {
                setIsToolbarActive(!isToolbarActive);
            };

            // Handle error display
            React.useEffect(() => {
                if (error) {
                    const timer = setTimeout(() => setError(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [error]);

            return (
                <div>
                    <header className="bg-gradient-to-r from-teal-400 to-pink-400 text-white p-3 flex justify-between items-center fixed w-full top-0 z-[1000]">
                        <div className="flex items-center cursor-pointer" onClick={toggleToolbar}>
                            <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo" className="h-10" />
                            <span className="ml-2 text-lg font-bold">BRIN</span>
                            <span className="ml-2 text-sm">Badan Riset Nasional</span>
                        </div>
                        <div>
                            <span>Parking Management System</span>
                        </div>
                    </header>

                    <aside className={`fixed top-16 ${isToolbarActive ? 'left-0' : '-left-96'} w-56 h-full bg-gradient-to-b from-teal-400 to-pink-400 p-4 shadow-lg z-[999] overflow-y-auto transition-all duration-300`}>
                        <div className="bg-gray-200 rounded-lg p-3 mb-4 text-center">
                            <h3 className="text-sm font-bold text-black mb-2">User</h3>
                            <img src={user?.profilePic || '/assets/user.JPG'} alt="User" className="w-10 h-10 rounded-full mx-auto mb-2" />
                            <span className="block text-xs text-black">Welcome Back</span>
                            <span className="block text-xs text-black">{user?.username || ''}</span>
                            <button className="w-full py-1 mt-2 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white" onClick={() => window.location.href='/profile.html'}>Profile</button>
                            <button className="w-full py-1 mt-2 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white" onClick={handleLogout}>Log Out</button>
                        </div>
                        <div className="bg-gray-200 rounded-lg p-3">
                            <h3 className="text-sm font-bold text-black mb-2">Parking Management System</h3>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white" onClick={() => window.location.href='/index.html'}>Live Overview</button>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white" onClick={() => window.location.href='/previous-analysis.html'}>Previous Analysis</button>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white">Export Data</button>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white">3D Viewer VR</button>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white">Helpdesk</button>
                            <button className="w-full py-1 mb-1 bg-gray-500 text-black rounded text-xs hover:bg-slate-700 hover:text-white" onClick={() => window.location.href='/parkinganalysis.html'}>Parking Analysis</button>
                        </div>
                    </aside>

                    <main className={`p-5 pt-20 min-h-screen ${isToolbarActive ? 'ml-60' : 'ml-0'} transition-all duration-300`}>
                        <div className="bg-gray-200 p-3 rounded-lg border-2 border-red-500 min-h-[150px]">
                            <h1 className="text-blue-600 text-lg mb-2">Parking Analysis (Messages)</h1>
                            <div className="mb-2 text-sm">
                                <span className="font-bold text-gray-600">Current Time:</span> <span>{currentTime}</span>
                            </div>
                            <div className="mb-2">
                                <select className="p-2 text-sm border rounded bg-white cursor-pointer" value={sortOption} onChange={(e) => setSortOption(e.target.value)}>
                                    <option value="slot">Sort by Slot</option>
                                    <option value="newest">Sort by Newest</option>
                                    <option value="oldest">Sort by Oldest</option>
                                </select>
                            </div>
                            <div className="max-h-80 overflow-y-auto border border-gray-300 p-2 rounded">
                                {messages.length === 0 ? (
                                    <div>No messages available</div>
                                ) : (
                                    messages.map((msg, index) => {
                                        const [dateStr, timeStr] = msg.timeKey.split(" ");
                                        const [year, month, day] = dateStr.split("-");
                                        const tanggalDisplay = `${day}-${month}-${year}`;
                                        const jamDisplay = timeStr ? timeStr.slice(0, 5) : 'N/A';
                                        return (
                                            <div key={index} className="grid grid-cols-[0.5fr_1fr_0.5fr_1fr] py-1 text-xs items-center gap-1 border-b border-gray-200">
                                                <span><strong>{msg.slotKey.replace('slot_', 'Slot ')}</strong></span>
                                                <span>{tanggalDisplay}</span>
                                                <span>{jamDisplay}</span>
                                                <span>{msg.msgValue}</span>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                            {error && (
                                <div className="absolute top-2 left-1/2 transform -translate-x-1/2 bg-red-600 text-white p-2 rounded text-xs z-[102]">
                                    {error}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>